generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                   String         @id @default(cuid())
  email                String         @unique
  name                 String?
  role                 UserRole       @default(STAFF)
  isActive             Boolean        @default(true)
  languages            LanguageCode[] @default([])
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  assignedReservations Reservation[]  @relation("GuideAssignments")

  @@index([role, isActive])
}

model Customer {
  id           String        @id @default(cuid())
  name         String
  email        String?       @unique
  phone        String?
  createdAt    DateTime      @default(now())
  reservations Reservation[]

  @@index([email])
}

model Experience {
  id                 String         @id @default(cuid())
  slug               String         @unique
  title              String
  description        String
  type               ExperienceType
  durationMin        Int
  difficulty         String?
  coverImage         String?
  location           String?
  isPublished        Boolean        @default(false)
  supportedLanguages LanguageCode[] @default([])
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  sessions           Session[]
}

model Session {
  id                       String        @id @default(cuid())
  experienceId             String
  startAt                  DateTime
  endAt                    DateTime?
  meetingPoint             String
  mapsUrl                  String?
  maxSeatsTotal            Int
  maxPerGuide              Int
  bookingClosesAt          DateTime
  priceCents               Int
  currency                 String        @default("eur")
  requiresPayment          Boolean       @default(true)
  refundFullBeforeHours    Int           @default(48)
  refundPartialBeforeHours Int           @default(24)
  refundPartialPercent     Int           @default(50)
  isCancelled              Boolean       @default(false)
  createdAt                DateTime      @default(now())
  updatedAt                DateTime      @updatedAt
  reservations             Reservation[]
  experience               Experience    @relation(fields: [experienceId], references: [id], onDelete: Cascade)

  @@index([experienceId, startAt])
  @@index([startAt, bookingClosesAt])
}

model Reservation {
  id                String            @id @default(cuid())
  sessionId         String
  customerId        String
  guideUserId       String?
  status            ReservationStatus @default(HOLD)
  holdExpiresAt     DateTime?
  primaryLanguage   LanguageBase
  preferredLanguage LanguageCode?
  cancelledAt       DateTime?
  cancelReason      CancelReason?
  refundAmountCents Int               @default(0)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  payment           Payment?
  customer          Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  guideUser         User?             @relation("GuideAssignments", fields: [guideUserId], references: [id])
  session           Session           @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, customerId])
  @@index([sessionId, status])
  @@index([sessionId, guideUserId, status])
  @@index([status, holdExpiresAt])
  @@index([cancelReason, cancelledAt])
}

model Payment {
  id                      String        @id @default(cuid())
  reservationId           String        @unique
  status                  PaymentStatus @default(REQUIRES_PAYMENT)
  amountCents             Int
  currency                String        @default("eur")
  stripeCheckoutSessionId String?       @unique
  stripePaymentIntentId   String?       @unique
  stripeRefundId          String?       @unique
  refundedAmountCents     Int           @default(0)
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
  reservation             Reservation   @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([status])
}

enum ExperienceType {
  BIKE_TOUR
  KAYAK_TOUR
  WALKING_TOUR
  MINI_CRUISE
}

enum LanguageBase {
  CA
  ES
  EN
}

enum LanguageCode {
  CA
  ES
  EN
  DE
  FR
  IT
}

enum UserRole {
  ADMIN
  GUIDE
  STAFF
}

enum ReservationStatus {
  HOLD
  CONFIRMED
  WAITING
  CANCELLED
  EXPIRED
}

enum PaymentStatus {
  NOT_REQUIRED
  REQUIRES_PAYMENT
  PENDING
  SUCCEEDED
  FAILED
  CANCELED
  REFUNDED
}

enum CancelReason {
  CUSTOMER
  OPERATOR
  WEATHER
}
